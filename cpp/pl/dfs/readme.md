# DFS(Distributed File System)

## 设计点

考虑到文件可能非常大，并且大小不均，DFS会把文件分成一个个block来存储，每个block大小为64MB（可配置）。但是通常情况下，不会设置太小。

- 使用DFS系统的需求存储的文件都偏大，所以较大的block有利于减少系统内部的寻址和交互次数;
- 大的block意味着client可能在一个block上执行多次操作，这可以复用连接，节省网络开销;
- 更大的block可以减少block的数量，从而节省元数据存储开销，相当于节省了内存资源;

DFS的master设计

- 文件位置等信息 -> 元数据
- 单点还是分布式？

|          | 单中心节点                 | 多中心节点                                       |
| -------- | -------------------------- | ------------------------------------------------ |
| 优点     | 实现难度低，一致性容易保证 | 实现难度极高，一致性难以保证，系统可靠性难以验证 |
| 缺点     | 成为整个系统的瓶颈         | 不存在瓶颈，可扩展性强                           |
| 工作重心 | 缩减元数据，减少master压力 | 设计一个分布式的元数据管理系统，并验证其可靠性   |

目前可以先考虑采用单master节点的方案。

master用来存储整个文件系统的三类元数据：

- 所有文件和block的namespace【持久化】
- 文件到block的映射【持久化】
- 每个block的位置【不持久化】

DFS读取文件的过程简单概括为：
文件名 -> 获取文件对应的所有block -> 获取所有block的位置 -> 依次到对应的datanode中读取block

为什么block的位置不做持久化？
因为master在启动的时候，可以从各个datanode收集block的位置信息。

master高可用设计

- master采用主备方案，当前正在使用的master为主，另一个为从
- 主master接收写请求，并向从同步wal，只有从同步完成，元数据才算操作成功

block的高可用设计

- 文件是被拆分成多个block来存储的，每个block都有三个副本。所以，文件数据的高可用是以block为粒度来保持的;
- master来维持block的副本信息;
- 对一个block的每次写入，必须确保三个副本都写入完成，才视为成功;
- 一个block的所有副本都具有完整的数据;
- 如果datanode宕机，它上面的所有block都有另外两个副本;
- 如果这个宕机的副本在一段时间内没有恢复，那么master就会在其他datanode上重建副本，确保副本数维持在3个;

## 支持的操作
